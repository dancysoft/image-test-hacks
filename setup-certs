#!/bin/bash

set -eu -o pipefail

# Lifetime of certs generated by this script
DAYS=1000

tlsdir="$(dirname "$0")/tls"
mkdir -p "$tlsdir"
cd "$tlsdir"

function genkey {
    local path="$1"

    if [ ! -f "$path" ]; then
        openssl genrsa -out "$path"
    fi
}

function gencacert {
    local path="$1"
    local key="$2"
    local subject="$3"

    if [ ! -f "$path" ]; then
        openssl req -x509 -new -out "$path" -key "$key" -subj "/CN=$subject" -days "$DAYS"
    fi
}

function gencsr {
    local path="$1"
    local key="$2"
    local subject="$3"

    if [ ! -f "$path" ]; then
        openssl req -new -out "$path" -key "$key" -subj "/CN=$subject" 
    fi
}

function csr2cert {
    local certpath="$1"
    local csrpath="$2"
    local altnames="${3:-}"

    if [ ! -f "$certpath" ]; then
        local extsconfig

        extsconfig=$(mktemp)

        cat <<EOF > "$extsconfig"
[exts]
basicConstraints=CA:FALSE
EOF
        if [ "$altnames" ]; then
            echo "subjectAltName=$altnames" >> "$extsconfig"
        fi

        openssl x509 -req -in "$csrpath" -out "$certpath" \
                -days "$DAYS" \
                -CA dev-ca.crt -CAkey dev-ca-key.pem -CAcreateserial \
                -extfile "$extsconfig" -extensions exts

        rm "$extsconfig"
    fi
}


# CA
genkey dev-ca-key.pem
gencacert dev-ca.crt dev-ca-key.pem devnet

# db
genkey db-key.pem
gencsr db.csr db-key.pem db
csr2cert db.pem db.csr

# www
genkey www-key.pem
gencsr www.csr www-key.pem www
csr2cert www.pem www.csr DNS:wikipedia.org,DNS:www.wikipedia.org,DNS:en.wikipedia.org,DNS:test.wikipedia.org
